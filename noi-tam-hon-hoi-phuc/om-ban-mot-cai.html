<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ªû ƒê√¢y C√≥ Nh·ªØng C√°i √îm | HOPE Project</title>
    
    <link rel="icon" href="data:,">

    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap&subset=vietnamese" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- STYLE CH·ª¶ ƒê·∫†O: ·∫§M √ÅP & CH·ªÆA L√ÄNH --- */
        :root {
            --primary: #9575CD;       /* T√≠m Lavender */
            --primary-dark: #7E57C2;
            --accent: #FF8A65;        /* Cam San H√¥ */
            --bg-gradient: linear-gradient(135deg, #FFF3E0 0%, #F3E5F5 100%);
            --text-main: #555;
            --text-heading: #2d3436;
            --glass-bg: rgba(255, 255, 255, 0.9);
            --shadow: 0 10px 30px 0 rgba(149, 117, 205, 0.15);
            
            /* M√†u Chat */
            --chat-user-bg: #E3F2FD;
            --chat-ai-bg: #F3E5F5;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; scroll-behavior: smooth; }

        body {
            font-family: 'Nunito', sans-serif;
            color: var(--text-main);
            background: var(--bg-gradient);
            line-height: 1.8;
            overflow-x: hidden;
        }

        /* --- HEADER & NAV --- */
        .top-disclaimer {
            background-color: var(--accent);
            color: white;
            text-align: center;
            padding: 8px 15px;
            font-size: 0.9rem;
            font-weight: 700;
        }

        header {
            position: sticky; top: 0; z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(149, 117, 205, 0.2);
        }

        .container { max-width: 1100px; margin: 0 auto; padding: 0 20px; }

        nav { display: flex; justify-content: space-between; align-items: center; height: 70px; }

        .logo { font-size: 1.5rem; font-weight: 800; color: var(--primary); text-decoration: none; display: flex; align-items: center; gap: 8px; }
        
        .nav-links { display: flex; gap: 20px; list-style: none; align-items: center; margin: 0; padding: 0; }
        .nav-links li { position: relative; height: 100%; display: flex; align-items: center; }
        
        .nav-links > li > a { 
            text-decoration: none; color: var(--text-heading); font-weight: 600; 
            transition: 0.3s; position: relative; display: inline-block; padding: 10px 0; line-height: 1.5;
        }
        .nav-links > li > a:hover, .nav-links > li > a.active { color: var(--primary-dark); }
        .nav-links > li > a.active::after { 
            content: ''; position: absolute; width: 100%; height: 3px; bottom: -8px; left: 0; background-color: var(--primary); border-radius: 2px; 
        }

        .dropdown-content {
            display: none; position: absolute; background-color: #fff; min-width: 240px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1); z-index: 999; top: 100%; left: 0;
            border-radius: 10px; padding: 10px 0; border: 1px solid rgba(0,0,0,0.05);
            flex-direction: column; animation: fadeIn 0.3s ease;
        }
        .nav-links li:hover .dropdown-content { display: flex; }
        .dropdown-content li { width: 100%; display: block; }
        .dropdown-content a {
            color: #555 !important; padding: 12px 20px; text-decoration: none; display: block;
            font-size: 0.95rem; font-weight: 500; transition: all 0.2s; white-space: nowrap;
        }
        .dropdown-content a:hover { background-color: #F3E5F5; color: var(--primary) !important; padding-left: 25px; }
        
        .btn-cta { padding: 8px 20px; background: var(--primary); color: white; border-radius: 50px; text-decoration: none; font-weight: 700; transition: 0.3s; cursor: pointer; border: none; font-family: 'Nunito', sans-serif;}
        .btn-cta:hover { background: var(--primary-dark); transform: translateY(-2px); }

        /* --- HERO SECTION --- */
        .page-hero {
            text-align: center; padding: 100px 0 80px;
            background: url('https://images.unsplash.com/photo-1516575334481-f85287c2c81d?ixlib=rb-1.2.1&auto=format&fit=crop&w=1920&q=80') no-repeat center center/cover;
            position: relative; color: white; border-radius: 0 0 50px 50px; margin-bottom: 60px;
        }
        .page-hero::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 138, 101, 0.6); border-radius: 0 0 50px 50px;
        }
        .hero-content { position: relative; z-index: 1; }
        .hero-content h1 { font-size: 3.5rem; margin-bottom: 15px; font-weight: 800; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .hero-content p { font-size: 1.3rem; opacity: 1; max-width: 800px; margin: 0 auto; font-style: italic; }

        /* --- CONTENT --- */
        .content-block {
            background: white; padding: 40px; border-radius: 20px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.05); margin-bottom: 60px;
            border: 1px solid rgba(0,0,0,0.02);
        }

        /* --- SHARE BOX (GIAO DI·ªÜN PHONG B√å TH∆Ø - DEFAULT) --- */
        .share-container {
            background: #FFF3E0; padding: 40px; border-radius: 20px; position: relative;
            max-width: 750px; margin: 0 auto; border: 3px dashed #FFCCBC;
        }
        .share-container::before {
            content: 'HOPE'; font-weight: 900; color: #E64A19; opacity: 0.2;
            position: absolute; top: 20px; right: 20px; font-size: 2rem; border: 3px solid #E64A19; padding: 5px 15px; transform: rotate(-10deg);
        }
        .share-box h3 { text-align: center; color: #D84315; margin-bottom: 25px; font-size: 1.4rem; }
        
        .form-control {
            width: 100%; padding: 20px; border-radius: 15px; border: 2px solid #FFCCBC;
            font-family: 'Nunito', sans-serif; font-size: 1rem; margin-bottom: 20px; resize: none;
            background: white; transition: 0.3s;
        }
        .form-control:focus { outline: none; border-color: var(--accent); box-shadow: 0 0 0 4px rgba(255, 138, 101, 0.2); }

        .send-btn {
            background: linear-gradient(to right, #FF7043, #F4511E);
            color: white; border: none; padding: 15px 40px;
            border-radius: 50px; font-weight: 800; font-size: 1.1rem; cursor: pointer; display: block; margin: 0 auto;
            transition: 0.3s; box-shadow: 0 5px 15px rgba(244, 81, 30, 0.3);
        }
        .send-btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 25px rgba(244, 81, 30, 0.4); }

        /* --- CHAT INTERFACE --- */
        #chatSection { display: none; } /* ·∫®n m·∫∑c ƒë·ªãnh */

        .chat-container {
            max-width: 900px; margin: 0 auto;
            background: white; border-radius: 20px; overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1); border: 1px solid #eee;
        }
        
        .chat-header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white; padding: 20px; display: flex; align-items: center; justify-content: space-between;
        }
        .chat-title { display: flex; align-items: center; gap: 15px; font-weight: 700; font-size: 1.2rem; }
        .ai-avatar { 
            width: 50px; height: 50px; background: white; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.5rem;
            border: 3px solid #E1BEE7;
        }
        
        .chat-body {
            height: 500px; overflow-y: auto; padding: 30px; background: #FAFAFA;
            display: flex; flex-direction: column; gap: 20px;
        }

        .message {
            max-width: 80%; padding: 15px 20px; border-radius: 15px; font-size: 1rem; position: relative;
            animation: fadeIn 0.3s ease; line-height: 1.6;
        }
        .msg-ai {
            align-self: flex-start; background: var(--chat-ai-bg); color: #333;
            border-bottom-left-radius: 5px; border: 1px solid #E1BEE7;
        }
        .msg-user {
            align-self: flex-end; background: var(--chat-user-bg); color: #0277BD;
            border-bottom-right-radius: 5px; border: 1px solid #B3E5FC;
        }
        .msg-ai strong { color: var(--primary-dark); }
        .msg-ai ul { margin-left: 20px; }

        .chat-input-area {
            padding: 20px; background: white; border-top: 1px solid #eee;
            display: flex; gap: 15px; align-items: center;
        }
        .chat-input {
            flex-grow: 1; padding: 15px; border-radius: 50px; border: 2px solid #eee;
            font-family: 'Nunito', sans-serif; font-size: 1rem; transition: 0.3s;
        }
        .chat-input:focus { outline: none; border-color: var(--primary); }
        
        .chat-send-btn {
            width: 50px; height: 50px; border-radius: 50%; border: none;
            background: var(--primary); color: white; cursor: pointer;
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem;
            transition: 0.3s;
        }
        .chat-send-btn:hover { background: var(--primary-dark); transform: scale(1.1); }
        .chat-send-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* Typing indicator */
        .typing-indicator { font-style: italic; color: #888; font-size: 0.9rem; margin-left: 10px; display: none; }
        .typing-indicator span { animation: blink 1.4s infinite both; }
        .typing-indicator span:nth-child(2) { animation-delay: .2s; }
        .typing-indicator span:nth-child(3) { animation-delay: .4s; }
        @keyframes blink { 0% { opacity: .2; } 20% { opacity: 1; } 100% { opacity: .2; } }

        /* --- MODAL (ƒê·ªåC TH∆Ø) --- */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background-color: #fff; padding: 40px; border: none;
            width: 90%; max-width: 700px; border-radius: 25px; position: relative;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4); animation: zoomIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .close-modal {
            position: absolute; top: 15px; right: 25px;
            color: #aaa; font-size: 30px; font-weight: bold; cursor: pointer; transition: 0.3s;
        }
        .close-modal:hover { color: var(--accent); transform: rotate(90deg); }

        .letter-full-content { font-size: 1.1rem; color: #444; line-height: 1.8; max-height: 50vh; overflow-y: auto; margin-bottom: 20px; }
        
        /* Loading AI trong Modal */
        .ai-loading-modal { text-align: center; display: none; }
        .ai-spinner {
            border: 5px solid #f3f3f3; border-top: 5px solid var(--accent); border-radius: 50%;
            width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- LETTERS GRID --- */
        .letters-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; align-items: stretch;
        }
        .letter-card {
            background: white; padding: 35px 25px; border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); transition: all 0.4s;
            position: relative; cursor: pointer; overflow: hidden;
            border-bottom: 5px solid var(--primary); text-align: center;
            display: flex; flex-direction: column; justify-content: space-between;
        }
        .letter-card:hover { transform: translateY(-10px); box-shadow: 0 20px 40px rgba(149, 117, 205, 0.2); }
        .letter-icon {
            font-size: 3rem; color: var(--primary); margin-bottom: 20px;
            background: #F3E5F5; width: 80px; height: 80px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center; margin: 0 auto 20px; transition: 0.5s;
        }
        .letter-card:hover .letter-icon { background: var(--primary); color: white; transform: rotate(10deg); }
        .letter-title { font-size: 1.3rem; font-weight: 800; color: var(--text-heading); margin-bottom: 10px; }
        .letter-preview { font-size: 0.95rem; color: #777; display: block; font-style: italic; margin-bottom: 15px; }
        .letter-action { font-size: 0.9rem; font-weight: 700; color: var(--accent); opacity: 0; transform: translateY(10px); transition: 0.3s; margin-top: auto; }
        .letter-card:hover .letter-action { opacity: 1; transform: translateY(0); }

        @keyframes zoomIn { from {transform: scale(0.9); opacity: 0;} to {transform: scale(1); opacity: 1;} }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Footer */
        footer { background: linear-gradient(to right, var(--primary-dark), #512DA8); color: white; padding: 60px 0 20px; text-align: center; margin-top: 80px; }
        .footer-links a { color: white; margin: 0 10px; font-size: 1.5rem; }

        @media (max-width: 900px) {
            .letters-grid { grid-template-columns: 1fr; }
            .nav-links { display: none; }
            .hero-content h1 { font-size: 2.2rem; }
            .modal-content { padding: 30px; }
        }
    </style>
</head>
<body>

    <div class="top-disclaimer">
        <i class="fas fa-info-circle"></i> "Nh·ªØng n·ªôi dung c·ªßa website kh√¥ng thay th·∫ø nh·ªØng h·ªó tr·ª£ c·ªßa chuy√™n gia trong ng√†nh."
    </div>

    <header>
        <div class="container">
            <nav>
                <a href="../index.html" class="logo">
                    <i class="fas fa-heartbeat" style="color: var(--accent);"></i> HOPE Project
                </a>
                <ul class="nav-links">
                    <li><a href="../index.html">Trang ch·ªß</a></li>
                    <li><a href="../hieu-ve-ban-than/">Hi·ªÉu v·ªÅ b·∫£n th√¢n</a></li>
                    <li class="dropdown">
                        <a href="../thu-thach-tuoi-teen/">Th·ª≠ th√°ch tu·ªïi teen <i class="fas fa-chevron-down" style="font-size: 0.8em; margin-left: 5px;"></i></a>
                        <ul class="dropdown-content">
                            <li><a href="../thu-thach-tuoi-teen/roi-loan-lo-au.html">R·ªëi lo·∫°n lo √¢u</a></li>
                            <li><a href="../thu-thach-tuoi-teen/tram-cam.html">Tr·∫ßm c·∫£m</a></li>
                            <li><a href="../thu-thach-tuoi-teen/cung-on-dinh-lai-tam-trang.html">C√πng ·ªïn ƒë·ªãnh l·∫°i t√¢m tr·∫°ng</a></li>
                        </ul>
                    </li>
                    <li><a href="../tram-sac-nang-luong/">Tr·∫°m s·∫°c</a></li>
                    <li class="dropdown">
                        <a href="index.html" class="active">N∆°i t√¢m h·ªìn h·ªìi ph·ª•c <i class="fas fa-chevron-down" style="font-size: 0.8em; margin-left: 5px;"></i></a>
                        <ul class="dropdown-content" style="min-width: 250px;">
                            <li><a href="khi-nao-can-gap-chuyen-gia.html">Khi n√†o c·∫ßn g·∫∑p chuy√™n gia</a></li>
                            <li><a href="dia-chi-tin-cay.html">ƒê·ªãa ch·ªâ tin c·∫≠y</a></li>
                            <li><a href="minh-dang-chua-on.html">M√¨nh ƒëang ch∆∞a ·ªïn</a></li>
                            <li><a href="om-ban-mot-cai.html" class="active">·ªû ƒë√¢y c√≥ nh·ªØng c√°i √¥m</a></li>
                        </ul>
                    </li>
                </ul>
                <a href="minh-dang-chua-on.html" class="btn-cta">C·∫ßn gi√∫p ƒë·ª°?</a>
            </nav>
        </div>
    </header>

    <section class="page-hero">
        <div class="container hero-content">
            <h1>G·ª≠i B·∫°n M·ªôt C√°i √îm</h1>
            <p>"T·ª•i m√¨nh, ai c≈©ng c·∫ßn c√≥ nh·ªØng c√°i √¥m..."</p>
        </div>
    </section>

    <main class="container">

        <section id="defaultSection" class="content-block reveal active">
            <div class="intro-text">
                <p style="text-align: center; margin-bottom: 20px;">C√≥ nh·ªØng l√∫c b·∫°n mu·ªën n√≥i ra n·ªói l√≤ng, nh∆∞ng l·∫°i kh√¥ng bi·∫øt ph·∫£i b·∫Øt ƒë·∫ßu t·ª´ ƒë√¢u? <br> H√£y vi·∫øt v√†i d√≤ng v√†o chi·∫øc h·ªôp b√™n d∆∞·ªõi, "Chuy√™n vi√™n Hy V·ªçng" c·ªßa ch√∫ng m√¨nh s·∫Ω g·ª≠i l·∫°i b·∫°n m·ªôt b·ª©c th∆∞ h·ªìi ƒë√°p th·∫≠t ·∫•m √°p nh√©.</p>
            </div>

            <div class="share-container">
                <h3><i class="fas fa-envelope-open-text"></i> G·ª≠i t√¢m s·ª± v√†o H·ªôp th∆∞ Hy V·ªçng</h3>
                <textarea id="userMessage" class="form-control" rows="5" placeholder="Vi·∫øt nh·ªØng t√¢m t∆∞ c·ªßa b·∫°n v√†o ƒë√¢y... (V√≠ d·ª•: H√¥m nay m√¨nh c·∫£m th·∫•y r·∫•t t·ªá v√¨ b·ªã ƒëi·ªÉm k√©m...)"></textarea>
                <button class="send-btn" onclick="sendHugRequest()"><i class="fas fa-paper-plane"></i> G·ª≠i ƒêi & Nh·∫≠n C√°i √îm</button>
            </div>
        </section>

        <section id="chatSection" class="content-block reveal">
            <div class="chat-container">
                <div class="chat-header">
                    <div class="chat-title">
                        <div class="ai-avatar"><i class="fas fa-robot"></i></div>
                        <div>
                            <span>G√≥c T√¢m S·ª± C√πng HOPE AI</span>
                            <span style="display: block; font-size: 0.8rem; opacity: 0.9; font-weight: 400;">Lu√¥n l·∫Øng nghe, kh√¥ng ph√°n x√©t</span>
                        </div>
                    </div>
                    <button onclick="clearChatData()" style="background: none; border: 1px solid white; color: white; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-size: 0.8rem;">K·∫øt th√∫c</button>
                </div>

                <div class="chat-body" id="chatBody">
                    </div>

                <div class="typing-indicator" id="typingIndicator">HOPE AI ƒëang so·∫°n tin nh·∫Øn<span>.</span><span>.</span><span>.</span></div>

                <div class="chat-input-area">
                    <input type="text" id="chatInput" class="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn c·ªßa b·∫°n..." onkeypress="handleEnter(event)">
                    <button id="chatSendBtn" class="chat-send-btn" onclick="sendMessage()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </section>

        <section class="content-block reveal">
            <h2 style="margin-bottom: 10px; text-align: center; color: var(--primary-dark);">G√≥c Chia S·∫ª & Th·∫•u C·∫£m</h2>
            <p style="text-align: center; margin-bottom: 50px; color: #666;">Nh·∫•n v√†o t·ª´ng phong b√¨ ƒë·ªÉ m·ªü nh·ªØng l√° th∆∞ g·ª≠i ri√™ng cho b·∫°n nh√©!</p>
            
            <div class="letters-grid">
                <div class="letter-card" onclick="openLetter('hope')">
                    <div class="letter-icon"><i class="fas fa-heart"></i></div>
                    <div class="letter-title">B·ª©c th∆∞ t·ª´ HOPE</div>
                    <span class="letter-preview">"G·ª≠i c·∫≠u, ng∆∞·ªùi ƒëang c·ªë g·∫Øng m·ªói ng√†y..."</span>
                    <div class="letter-action">Nh·∫•n ƒë·ªÉ ƒë·ªçc <i class="fas fa-arrow-right"></i></div>
                </div>

                <div class="letter-card" onclick="openLetter('duck')" style="border-color: #FF7043;">
                    <div class="letter-icon" style="color: #FF7043; background: #FFEBEE;"><i class="fas fa-dove"></i></div>
                    <div class="letter-title">G·ª≠i "Duck"</div>
                    <span class="letter-preview">V·ªÅ vi·ªác "S·∫°c pin" cho t√¢m h·ªìn...</span>
                    <div class="letter-action" style="color: #FF7043;">Nh·∫•n ƒë·ªÉ ƒë·ªçc <i class="fas fa-arrow-right"></i></div>
                </div>

                <div class="letter-card" onclick="openLetter('jen')" style="border-color: #3F51B5;">
                    <div class="letter-icon" style="color: #3F51B5; background: #E8EAF6;"><i class="fas fa-star"></i></div>
                    <div class="letter-title">G·ª≠i Jen</div>
                    <span class="letter-preview">V·ªÅ s·ª± t·∫≠p trung v√† xao nh√£ng...</span>
                    <div class="letter-action" style="color: #3F51B5;">Nh·∫•n ƒë·ªÉ ƒë·ªçc <i class="fas fa-arrow-right"></i></div>
                </div>
            </div>
        </section>

    </main>

    <div id="letterModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeLetter()">&times;</span>
            
            <div id="aiLoading" class="ai-loading-modal">
                <div class="ai-spinner"></div>
                <p>HOPE AI ƒëang vi·∫øt th∆∞ h·ªìi √¢m cho b·∫°n...</p>
            </div>

            <div id="modalBody" class="letter-full-content">
                </div>
            
            <div style="text-align: center; margin-top: 30px;" id="modalFooter">
                <button onclick="closeLetter()" class="btn-cta" style="background: #999;">ƒê√≥ng th∆∞</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="container footer-content">
            <h3 style="margin-bottom: 25px; font-size: 1.8rem;">HOPE - FSchool C·∫ßn Th∆°</h3>
            <p style="margin-bottom: 25px;">D·ª± √°n phi l·ª£i nhu·∫≠n c·ªßa h·ªçc sinh v√¨ h·ªçc sinh.</p>
            <div class="footer-links">
                <a href="#"><i class="fab fa-facebook"></i></a>
                <a href="#"><i class="fas fa-envelope"></i></a>
            </div>
        </div>
    </footer>

    <script src="key.js"></script>

    <script>
        // --- 1. CONFIG & INIT ---
        const chatHistory = []; // L∆∞u l·ªãch s·ª≠ chat phi√™n hi·ªán t·∫°i
        let isChatMode = false;
        
        // Bi·∫øn l∆∞u tr·ªØ t·∫°m th·ªùi cho ch·ª©c nƒÉng g·ª≠i th∆∞
        let currentHugUserMsg = "";
        let currentHugAiReply = "";

        window.onload = function() {
            checkStorageForChat();
        };

        function checkStorageForChat() {
            const surveyData = localStorage.getItem("hope_user_survey");
            const initialReply = localStorage.getItem("hope_ai_initial_reply");

            if (surveyData && initialReply) {
                // C√≥ d·ªØ li·ªáu t·ª´ b√†i test -> B·∫≠t ch·∫ø ƒë·ªô Chat ngay
                isChatMode = true;
                document.getElementById("defaultSection").style.display = "none";
                document.getElementById("chatSection").style.display = "block";
                
                // Load n·ªôi dung c≈©
                addMessageToUI("user", "ƒê√¢y l√† k·∫øt qu·∫£ kh·∫£o s√°t c·ªßa m√¨nh:\n" + surveyData);
                addMessageToUI("ai", initialReply);
                
                // L∆∞u v√†o history
                chatHistory.push({ role: "user", content: surveyData });
                chatHistory.push({ role: "assistant", content: initialReply });
            }
        }

        function clearChatData() {
            if(confirm("B·∫°n c√≥ mu·ªën k·∫øt th√∫c cu·ªôc tr√≤ chuy·ªán v√† x√≥a d·ªØ li·ªáu t·∫°m th·ªùi kh√¥ng?")) {
                localStorage.removeItem("hope_user_survey");
                localStorage.removeItem("hope_ai_initial_reply");
                location.reload(); 
            }
        }

        // --- 2. LOGIC G·ªåI API (D√ôNG CHUNG) ---
        async function fetchWithKeyRotation(payload, maxRetries) {
            if (typeof maxRetries === 'undefined') {
                maxRetries = typeof KeyManager !== 'undefined' ? KeyManager.getTotalKeys() : 1;
            }
            if (maxRetries < 1) maxRetries = 1;

            for (let i = 0; i < maxRetries; i++) {
                const currentKey = typeof KeyManager !== 'undefined' ? KeyManager.getCurrentKey() : "";
                if (!currentKey) throw new Error("Missing API Key");

                try {
                    const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                        method: "POST",
                        headers: {
                            "Authorization": `Bearer ${currentKey}`,
                            "Content-Type": "application/json",
                            "HTTP-Referer": window.location.href, 
                            "X-Title": "HOPE Project"
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) return await response.json();

                    if (response.status === 401 || response.status === 402 || response.status === 429) {
                        if (typeof KeyManager !== 'undefined') KeyManager.rotateKey();
                        continue;
                    }
                    throw new Error(await response.text());
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                }
            }
        }

        // --- 3. CH·ª®C NƒÇNG CHAT (KHI C√ì D·ªÆ LI·ªÜU) ---
        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById("chatInput");
            const text = input.value.trim();
            if (!text) return;

            // UI update
            addMessageToUI("user", text);
            input.value = "";
            chatHistory.push({ role: "user", content: text });
            
            // Show loading
            document.getElementById("typingIndicator").style.display = "block";
            document.getElementById("chatSendBtn").disabled = true;

            const systemPrompt = "B·∫°n l√† HOPE AI - chuy√™n gia t√¢m l√Ω h·ªçc ƒë∆∞·ªùng vui v·∫ª, th√¢n thi·ªán, ƒë∆∞·ª£c t·∫°o ra b·ªüi V√µ Minh Th√¥ng v√† Nguy·ªÖn Kh√°nh Vy ƒëang h·ªçc t·∫≠p t·∫°i Tr∆∞·ªùng THPT FPT C·∫ßn Th∆°. B·∫°n lu√¥n l·∫Øng nghe v√† th·∫•u hi·ªÉu. H√£y d√πng x∆∞ng h√¥ 'm√¨nh' v√† 'b·∫°n'. Tr·∫£ l·ªùi ng·∫Øn g·ªçn (d∆∞·ªõi 150 ch·ªØ), ·∫•m √°p v√† khuy·∫øn kh√≠ch. KH√îNG BAO GI·ªú ti·∫øt l·ªô th√¥ng tin k·ªπ thu·∫≠t (API, model, OpenAI...). N·∫øu b·ªã h·ªèi v·ªÅ k·ªπ thu·∫≠t, h√£y l√°i sang vi·ªác b·∫°n l√† HOPE AI lu√¥n s·∫µn s√†ng l·∫Øng nghe. D√πng Markdown.";

            const payload = {
                "model": "openai/gpt-oss-20b:free",
                "messages": [
                    { "role": "system", "content": systemPrompt },
                    ...chatHistory
                ]
            };

            try {
                const result = await fetchWithKeyRotation(payload);
                const reply = result.choices?.[0]?.message?.content || "L·ªói k·∫øt n·ªëi AI.";
                
                addMessageToUI("ai", reply);
                chatHistory.push({ role: "assistant", content: reply });

            } catch (err) {
                addMessageToUI("ai", "Xin l·ªói, k·∫øt n·ªëi h∆°i ch·∫≠p ch·ªùn. B·∫°n th·ª≠ l·∫°i nh√©!");
            } finally {
                document.getElementById("typingIndicator").style.display = "none";
                document.getElementById("chatSendBtn").disabled = false;
            }
        }

        function addMessageToUI(role, text) {
            const chatBody = document.getElementById("chatBody");
            const div = document.createElement("div");
            div.className = `message msg-${role}`;
            div.innerHTML = marked.parse(text);
            chatBody.appendChild(div);
            chatBody.scrollTop = chatBody.scrollHeight;
        }

        // --- 4. CH·ª®C NƒÇNG G·ª¨I TH∆Ø (DEFAULT MODE) ---
        async function sendHugRequest() {
            const userMsg = document.getElementById("userMessage").value.trim();
            if (!userMsg) {
                alert("B·∫°n ch∆∞a vi·∫øt g√¨ c·∫£ n√®! H√£y vi·∫øt v√†i d√≤ng nh√©.");
                return;
            }

            // M·ªü modal loading
            const modal = document.getElementById("letterModal");
            const content = document.getElementById("modalBody");
            const loading = document.getElementById("aiLoading");
            const footer = document.getElementById("modalFooter");
            
            modal.style.display = "flex";
            content.innerHTML = "";
            loading.style.display = "block";
            
            // Reset footer ch·ªâ c√≥ n√∫t ƒë√≥ng trong l√∫c ch·ªù
            footer.innerHTML = '<button onclick="closeLetter()" class="btn-cta" style="background: #999;">ƒê√≥ng th∆∞</button>';

            const systemPrompt = "B·∫°n l√† HOPE AI - m·ªôt ng∆∞·ªùi b·∫°n ·∫£o vui v·∫ª, ·∫•m √°p ƒë∆∞·ª£c t·∫°o ra b·ªüi hai b·∫°n h·ªçc sinh V√µ Minh Th√¥ng v√† Nguy·ªÖn Kh√°nh Vy ƒëang h·ªçc t·∫≠p t·∫°i Tr∆∞·ªùng THPT FPT C·∫ßn Th∆°. Nhi·ªám v·ª• c·ªßa b·∫°n l√† ƒë·ªçc t√¢m s·ª± c·ªßa ng∆∞·ªùi d√πng v√† vi·∫øt l·∫°i m·ªôt b·ª©c th∆∞ h·ªìi √¢m ng·∫Øn (kho·∫£ng 100-150 ch·ªØ) ƒë·ªÉ an ·ªßi, ƒë·ªông vi√™n v√† g·ª≠i m·ªôt 'c√°i √¥m ·∫£o'. Gi·ªçng vƒÉn nh·∫π nh√†ng, cute, d√πng x∆∞ng h√¥ 'm√¨nh' v√† 'b·∫°n', s·ª≠ d·ª•ng emoji. Tuy·ªát ƒë·ªëi kh√¥ng ti·∫øt l·ªô v·ªÅ c√¥ng ngh·ªá, API hay model AI. N·∫øu ƒë∆∞·ª£c h·ªèi v·ªÅ ngu·ªìn g·ªëc, ch·ªâ tr·∫£ l·ªùi l√† HOPE AI do Th√¥ng v√† Vy t·∫°o ra.";

            const payload = {
                "model": "openai/gpt-oss-20b:free",
                "messages": [
                    { "role": "system", "content": systemPrompt },
                    { "role": "user", "content": userMsg }
                ]
            };

            try {
                const result = await fetchWithKeyRotation(payload);
                const reply = result.choices?.[0]?.message?.content || "H·ªôp th∆∞ ƒëang k·∫πt... Th·ª≠ l·∫°i sau nh√©!";
                
                // L∆∞u l·∫°i d·ªØ li·ªáu ƒë·ªÉ d√πng n·∫øu ng∆∞·ªùi d√πng mu·ªën chat ti·∫øp
                currentHugUserMsg = userMsg;
                currentHugAiReply = reply;

                loading.style.display = "none";
                content.innerHTML = marked.parse(reply);
                
                // C·∫≠p nh·∫≠t Footer: Th√™m n√∫t Chat Ti·∫øp
                footer.innerHTML = `
                    <button onclick="transitionToChat()" class="btn-cta" style="background: linear-gradient(to right, #42A5F5, #1976D2); margin-right: 10px;">
                        <i class="fas fa-comments"></i> Tr√≤ chuy·ªán ti·∫øp
                    </button>
                    <button onclick="closeLetter()" class="btn-cta" style="background: #999;">ƒê√≥ng th∆∞</button>
                `;
                
            } catch (err) {
                loading.style.display = "none";
                content.innerHTML = "<p style='color:red'>H·ªá th·ªëng ƒëang b·∫≠n, nh∆∞ng HOPE v·∫´n g·ª≠i b·∫°n m·ªôt c√°i √¥m th·∫≠t ch·∫∑t! (L·ªói k·∫øt n·ªëi)</p>";
            }
        }
        
        // H√†m chuy·ªÉn t·ª´ ch·∫ø ƒë·ªô Th∆∞ sang Chat
        function transitionToChat() {
            closeLetter(); // ƒê√≥ng modal
            
            // Chuy·ªÉn giao di·ªán
            document.getElementById("defaultSection").style.display = "none";
            document.getElementById("chatSection").style.display = "block";
            
            // ƒê·∫©y d·ªØ li·ªáu v√†o Chat UI
            addMessageToUI("user", currentHugUserMsg);
            addMessageToUI("ai", currentHugAiReply);
            
            // L∆∞u v√†o history ƒë·ªÉ AI nh·ªõ ng·ªØ c·∫£nh
            chatHistory.push({ role: "user", content: currentHugUserMsg });
            chatHistory.push({ role: "assistant", content: currentHugAiReply });
            
            isChatMode = true;
        }

        // --- 5. LOGIC MODAL & TH∆Ø C√ì S·∫¥N ---
        const letters = {
            hope: `
                <h2 style="text-align: center; color: #9575CD;">NH·ªÆNG C√ÅI √îM G·ª¨I C·∫¨U ‚ù§Ô∏è</h2>
                <p>Ch√†o c·∫≠u,</p>
                <p>C√≥ l·∫Ω h√¥m nay l√† m·ªôt ng√†y d√†i, ho·∫∑c c√≥ th·ªÉ ch·ªâ l√† c·∫≠u c·∫£m th·∫•y c·∫ßn m·ªôt ch√∫t ·ªßi an. D√π l√Ω do l√† g√¨, HOPE r·∫•t vui v√¨ c·∫≠u ƒë√£ gh√© l·∫°i ƒë√¢y.</p>
                <p>Ch√∫ng m√¨nh mu·ªën c·∫≠u bi·∫øt r·∫±ng: <strong>C·∫£m x√∫c c·ªßa c·∫≠u l√† h·ª£p l·ªá.</strong> V√† vi·ªác c·∫≠u d·ª´ng l·∫°i m·ªôt ch√∫t ƒë·ªÉ ngh·ªâ ng∆°i kh√¥ng ph·∫£i l√† l∆∞·ªùi bi·∫øng, m√† l√† y√™u th∆∞∆°ng b·∫£n th√¢n.</p>
                <p style="text-align: right; font-weight: bold; margin-top: 30px;">- Th√¢n th∆∞∆°ng, Team HOPE -</p>
            `,
            duck: `
                <h2 style="text-align: center; color: #FF7043;">G·ª¨I "DUCK" üïäÔ∏è</h2>
                <p>V·ªÅ vi·ªác "S·∫°c pin" cho t√¢m h·ªìn... ƒê√¥i khi kh√¥ng l√†m g√¨ c·∫£ c≈©ng l√† m·ªôt c√°ch s·∫°c pin tuy·ªát v·ªùi ƒë·∫•y!</p>
            `,
            jen: `
                <h2 style="text-align: center; color: #3F51B5;">G·ª¨I JEN ‚≠ê</h2>
                <p>V·ªÅ s·ª± t·∫≠p trung: ƒê·ª´ng qu√° kh·∫Øt khe v·ªõi b·∫£n th√¢n. M·ªôt b∆∞·ªõc nh·ªè c≈©ng l√† ti·∫øn b·ªô.</p>
            `
        };

        function openLetter(type) {
            const modal = document.getElementById("letterModal");
            const content = document.getElementById("modalBody");
            const footer = document.getElementById("modalFooter");
            
            document.getElementById("aiLoading").style.display = "none"; 
            
            // Reset footer v·ªÅ m·∫∑c ƒë·ªãnh (ch·ªâ n√∫t ƒê√≥ng) v√¨ th∆∞ c√≥ s·∫µn kh√¥ng c√≥ context ƒë·ªÉ chat ti·∫øp
            footer.innerHTML = '<button onclick="closeLetter()" class="btn-cta" style="background: #999;">ƒê√≥ng th∆∞</button>';
            
            content.innerHTML = letters[type];
            modal.style.display = "flex";
        }

        function closeLetter() {
            document.getElementById("letterModal").style.display = "none";
        }

        window.onclick = function(event) {
            const modal = document.getElementById("letterModal");
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }

        // Scroll Reveal
        function reveal() {
            var reveals = document.querySelectorAll(".reveal");
            for (var i = 0; i < reveals.length; i++) {
                var windowHeight = window.innerHeight;
                var elementTop = reveals[i].getBoundingClientRect().top;
                var elementVisible = 100;
                if (elementTop < windowHeight - elementVisible) reveals[i].classList.add("active");
            }
        }
        window.addEventListener("scroll", reveal);
        reveal();
    </script>
</body>
</html>
